#!/usr/bin/env node
import e from"fs";import r from"chalk";import o from"child_process";const n="./src/config/envVariable.ts",a=["drawboard.min.js","drawboard.min.js.LICENSE.txt","drawboard.min.js.map"],s=["/Users/yangzi/Desktop/kc-ocm-client/kc-ocm-client_1.0.24.1025/public/threedWorker/","/Users/yangzi/Desktop/kc-pad-drawboard/public/threedworker/"],c=[{name:"version",fun:o=>{const n=o.version;if(!n||11!==n.length)return void console.log(r.red("请输入正确的版本号, 如 x.xx.xxxxxx"));let a=n.replace(/1\./,"20.");a=a.replace(/\./g,"");let s=e.readFileSync("./android/app/build.gradle",{encoding:"utf8"});s=s.replace(/versionCode \d+/,`versionCode ${a}`),s=s.replace(/versionName \".+\"/,`versionName "${n}"`),e.writeFileSync("./android/app/build.gradle",s),console.log(r.green("[success] Android版本号修改成功(versionName:"+n,"versionCode: "+a+")"))}},{name:"env",fun:o=>{const{env:a,outputPath:s=n,isBuild:c}=o,i=`./env/${a}`;if(!a)return void console.log(r.red("[error] 请输入环境名称, 如 development/production"));if(!e.existsSync(i))return void console.log(r.red(`[error] ${a}, 该输配置文件不存在`));if(!e.existsSync(s))return void console.log(r.red(`[error] ${s}, 该输出目录文件不存在`));const l=`${(e=>{const r=e.split("\n");let o="";return r.forEach(((e,n)=>{if(r[n]=e.replace(/\s/g,""),r[n].indexOf("=")>0){const[e,a]=r[n].split("=");o+=`export const ${e} = '${a}';\n`}})),o})(e.readFileSync(i,"utf-8"))}`;e.writeFileSync(s,l),c?(console.log(r.green(`[success] 已将环境设置为: ${a}, 开始打包Android...`)),console.log(r.yellow("[warning] 请注意iOS的环境,最好先打包Android再打包iOS!!!"))):console.log(r.green(`[success] 已将环境设置为: ${a}`))}},{name:"openFolder",fun:async()=>{if(!e.existsSync("./android/app/"))return void console.log(r.red("[error] 没有android文件夹"));let n=e.readFileSync("./android/app/build.gradle",{encoding:"utf8"});let a=n.match(/versionName \".+\"/);if(a){a=a[0].split(" ")[1].replace(/\"/g,"");const n="./android/app/build/outputs/apk/release/";e.rename(`${n}app-arm64-v8a-release.apk`,`${n}${a}.apk`,(o=>{o?console.log(r.red("[error] 重命名文件出错")):(async r=>{const o=(await e.promises.stat(r)).size;return Math.ceil(o/1024/1024)})(`${n}${a}.apk`).then((e=>{console.log(r.green(`[success] 包目录已打开, 版本号: ${a}, 文件大小: ${e}MB`))}))})),o.exec("open ./android/app/build/outputs/apk/release/")}else console.log(r.red("[error] 版本号读取出错,请核对"))}},{name:"createImageType",fun:o=>{const{path:n}=o,a=e.readdirSync(n);let s={},c={};const i=["png","jpg","jpeg"];if(a.forEach((e=>{const r=e.split(".");if(i.includes(r[1])){const o=r[0];c[o]="ImageSourcePropType",s[o]=`require(./${e})`}})),0===Object.keys(s).length)return void console.log(r.yellow("[warning] 没有找到图片，请核对图片所在路径"));s=JSON.stringify(s,null,"\t"),s=s.replace(/:\s"/g,": "),s=s.replace(/\(/g,'("'),s=s.replace(/\)"/g,'")'),s=s.replace(/"/g,"'"),c=JSON.stringify(c,null,"\t"),c=c.replace(/:\s"/g,": "),c=c.replace(/,/g,";"),c=c.replace(/"/g,"");const l=`import {ImageSourcePropType} from 'react-native';\nexport interface ImagesProps${c}\nconst Images: ImagesProps = ${s} \nexport default Images`;e.writeFileSync(`${n}/Images.ts`,l)}},{name:"copyDrawboard",fun:()=>{let o=0;a.forEach((n=>{s.forEach((a=>{e.copyFile(`/Users/yangzi/Desktop/kc-draw-board/kc-draw-board_1.0.24.1025/dist/${n}`,`${a}${n}`,(()=>{o++,6===o&&console.log(r.green("打包文件拷贝成功"))}))}))}))}}],i=()=>{console.log("请输入以下方法:\nversion:         设置安卓版本号(e.g: apptool version:1.23.010101);\nenv:             设置当前环境参数(e.g: apptool env:production);\nopenFolder:      打开安卓打包文件夹,同时会把安装包命名为新的版本号;\ncreateImageType: 给图片添加ts类型, 可指定图片所在路径;(e.g: createIMageType path:./src/assets)\ncopyDrawboard:   复制drawboard打好的包到门店和pad的webview下\n")};!function(){const e=process.argv.splice(2),o={};if("-h"===e[0])return void i();e.forEach((e=>{const[r,n]=e.split(":");o[r]=n||!0}));let n=!1;for(let e=0;e<c.length;e++)if(o[c[e].name]){n=!0,c[e].fun(o);break}n||(console.log(r.red(`[error] 命令不正确 ${e}`)),i())}();
